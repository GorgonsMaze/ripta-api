<!DOCTYPE html>
<html>
<head>
  <title></title>

  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.16.6/lodash.js"></script>

  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.2/moment.min.js"></script>

</head>
<body>



<script type="text/javascript">
  $(document).ready(function(){

    var stopsIndexed;

    function tsToTime(ts) {
      return moment.unix(ts).format('h:mma');
    }

    function getStop(id) {
      if (stopsIndexed.hasOwnProperty(id)) {
        return stopsIndexed[id].stop_name;
      }
      return 'Unknown stop id: ' + id;
    }

    function getDelayStr(seconds) {
      secondsInt = parseInt(seconds, 10);
      if (seconds === 0) {
        return '(on time)';
      }
      var delay = secondsInt/60;
      var minuteStr = (Math.abs(delay) === 1) ? "minute" : "minutes";
      var modifier = (secondsInt < 0) ? "early" : "late"
      return Math.abs(delay) + " " + minuteStr + " " + modifier;
    }

    $.getJSON('/static/stops', function(stops){
        stopsIndexed = _.keyBy(stops, 'stop_id');
        displayTrips('60');
    });

    function displayTrips(routeStr) {
      $.getJSON('/api/tripupdates/route/' + routeStr, function(trips){
        console.log('Update created at ' + tsToTime(trips.header.timestamp));
        $.each(trips.entity, function(key, trip){
          var title = "Route " + routeStr;
          var startTime = trip.trip_update.trip.start_time;
          console.log(title, startTime);
          $.each(trip.trip_update.stop_time_update, function(key, update){
              if (update.arrival === null) {
                console.log('---------------------');
                console.log(update);
                console.log('---------------------');
              }
              else {
                var atime = tsToTime(update.arrival.time);
                var thisStop = getStop(update.stop_id);
                var delayStr = getDelayStr(update.arrival.delay);
                console.log(atime + ' ' + thisStop + ' ' + delayStr);
              }
          });
        });
      });
    }


  });





</script>

</body>
</html>
